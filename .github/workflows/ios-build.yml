name: Compilar App iOS

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v3
    
    - name: Listar archivos subidos
      run: |
        echo "Contenido del repositorio:"
        ls -la
        echo "Buscando archivos .xcodeproj:"
        find . -name "*.xcodeproj"
    
    - name: Compilar
      run: |
        # Encontrar el archivo .xcodeproj
        PROJECT=$(find . -name "*.xcodeproj" | head -n 1)
        echo "Proyecto encontrado: $PROJECT"
        
        # Listar schemes disponibles
        echo "Schemes disponibles:"
        xcodebuild -project "$PROJECT" -list
        
        # Obtener el primer scheme
        SCHEME=$(xcodebuild -project "$PROJECT" -list | grep -A 100 "Schemes:" | grep -v "Schemes:" | head -n 1 | xargs)
        echo "Scheme seleccionado: $SCHEME"
        
        # Compilar (usando Any iOS Simulator Device para compatibilidad)
        xcodebuild clean build \
          -project "$PROJECT" \
          -scheme "$SCHEME" \
          -destination 'platform=iOS Simulator,name=Any iOS Simulator Device' \
          -configuration Debug \
          -derivedDataPath ./build
    
    - name: Encontrar y comprimir .app
      run: |
        APP_PATH=$(find ./build -name "*.app" -type d | head -n 1)
        echo "App encontrada en: $APP_PATH"
        cd $(dirname "$APP_PATH")
        zip -r $GITHUB_WORKSPACE/appciudad.app.zip $(basename "$APP_PATH")
    
    - name: Subir artefacto
      uses: actions/upload-artifact@v4
      with:
        name: appciudad-ios
        path: appciudad.app.zip
        retention-days: 7

